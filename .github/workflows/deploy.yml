name: deploy

on:
    push:
        branches:
            - master

jobs:
    deploy:
        # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#choosing-github-hosted-runners
        runs-on: ubuntu-22.04
        steps:
            # https://github.com/marketplace/actions/checkout
            - uses: actions/checkout@v3.5.0
            # https://github.com/marketplace/actions/setup-node-js-environment
            - uses: actions/setup-node@v3.6.0
              with:
                  node-version: 18
            # https://github.com/marketplace/actions/cache
            - uses: actions/cache@v3.3.1
              with:
                  path: ~/.local/share/pnpm/store
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: ${{ runner.os }}-pnpm-
            - run: echo "$PATH"
            - run: |
                  corepack enable
                  # https://www.npmjs.com/package/pnpm
                  corepack prepare pnpm@8.1.0 --activate
                  pnpm config set store-dir ~/.local/share/pnpm/store
                  corepack enable pnpm
                  pnpm install
                  # https://www.npmjs.com/package/wrangler
                  pnpm add -g wrangler@2.13.0
                  pnpm store prune
              env:
                  PNPM_HOME: /home/runner/.local/bin

            - run: |
                  make -j check lint
                  make -j test
                  make -j build

            - working-directory: src/current-ip
              env:
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
              run: |
                  printf '${{ secrets.ROLLBAR_TG_BOT_TOKEN }}' | wrangler secret put 'ERR_TG_BOT_TOKEN'
                  printf '${{ secrets.ROLLBAR_TG_CHAT_ID }}' | wrangler secret put 'ERR_TG_CHAT_ID'
                  wrangler publish

            - working-directory: src/backup
              env:
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
              run: |
                  printf '${{ secrets.ROLLBAR_TG_BOT_TOKEN }}' | wrangler secret put 'ERR_TG_BOT_TOKEN'
                  printf '${{ secrets.ROLLBAR_TG_CHAT_ID }}' | wrangler secret put 'ERR_TG_CHAT_ID'
                  wrangler publish

            - working-directory: src/feedbox
              env:
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
              run: |
                  wrangler publish

            - working-directory: src/proxy-list
              env:
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
              run: |
                  printf '${{ secrets.ROLLBAR_TG_BOT_TOKEN }}' | wrangler secret put 'ERR_TG_BOT_TOKEN'
                  printf '${{ secrets.ROLLBAR_TG_CHAT_ID }}' | wrangler secret put 'ERR_TG_CHAT_ID'
                  wrangler publish

            - working-directory: src/email
              env:
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
              run: |
                  printf '${{ secrets.ROLLBAR_TG_BOT_TOKEN }}' | wrangler secret put 'ERR_TG_BOT_TOKEN'
                  printf '${{ secrets.ROLLBAR_TG_CHAT_ID }}' | wrangler secret put 'ERR_TG_CHAT_ID'
                  wrangler publish
